import{O as u,C}from"./constants-b44d1cff.js";function ge(s){return s.type==="CURVE"}function ye(s){return s.type==="IMAGE"}function k(s){return Array.isArray?Array.isArray(s):oe(s)==="[object Array]"}const Ie=1/0;function Me(s){if(typeof s=="string")return s;let e=s+"";return e=="0"&&1/s==-Ie?"-0":e}function Ee(s){return s==null?"":Me(s)}function b(s){return typeof s=="string"}function ae(s){return typeof s=="number"}function we(s){return s===!0||s===!1||Te(s)&&oe(s)=="[object Boolean]"}function ce(s){return typeof s=="object"}function Te(s){return ce(s)&&s!==null}function O(s){return s!=null}function X(s){return!s.trim().length}function oe(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}const Re="Incorrect 'index' type",xe=s=>`Invalid value for key ${s}`,Se=s=>`Pattern length exceeds max of ${s}.`,ve=s=>`Missing ${s} property in key`,Ae=s=>`Property 'weight' in key '${s}' must be a positive integer`,q=Object.prototype.hasOwnProperty;class Ne{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach(i=>{let n=le(i);t+=n.weight,this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight}),this._keys.forEach(i=>{i.weight/=t})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function le(s){let e=null,t=null,i=null,n=1,a=null;if(b(s)||k(s))i=s,e=ee(s),t=W(s);else{if(!q.call(s,"name"))throw new Error(ve("name"));const r=s.name;if(i=r,q.call(s,"weight")&&(n=s.weight,n<=0))throw new Error(Ae(r));e=ee(r),t=W(r),a=s.getFn}return{path:e,id:t,weight:n,src:i,getFn:a}}function ee(s){return k(s)?s:s.split(".")}function W(s){return k(s)?s.join("."):s}function Ce(s,e){let t=[],i=!1;const n=(a,r,c)=>{if(O(a))if(!r[c])t.push(a);else{let o=r[c];const l=a[o];if(!O(l))return;if(c===r.length-1&&(b(l)||ae(l)||we(l)))t.push(Ee(l));else if(k(l)){i=!0;for(let h=0,m=l.length;h<m;h+=1)n(l[h],r,c+1)}else r.length&&n(l,r,c+1)}};return n(s,b(e)?e.split("."):e,0),i?t:t[0]}const Oe={includeMatches:!1,findAllMatches:!1,minMatchCharLength:1},He={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(s,e)=>s.score===e.score?s.idx<e.idx?-1:1:s.score<e.score?-1:1},be={location:0,threshold:.6,distance:100},ke={useExtendedSearch:!1,getFn:Ce,ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var f={...He,...Oe,...be,...ke};const Le=/[^ ]+/g;function _e(s=1,e=3){const t=new Map,i=Math.pow(10,e);return{get(n){const a=n.match(Le).length;if(t.has(a))return t.get(a);const r=1/Math.pow(a,.5*s),c=parseFloat(Math.round(r*i)/i);return t.set(a,c),c},clear(){t.clear()}}}class J{constructor({getFn:e=f.getFn,fieldNormWeight:t=f.fieldNormWeight}={}){this.norm=_e(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((t,i)=>{this._keysMap[t.id]=i})}create(){this.isCreated||!this.docs.length||(this.isCreated=!0,b(this.docs[0])?this.docs.forEach((e,t)=>{this._addString(e,t)}):this.docs.forEach((e,t)=>{this._addObject(e,t)}),this.norm.clear())}add(e){const t=this.size();b(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,i=this.size();t<i;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!O(e)||X(e))return;let i={v:e,i:t,n:this.norm.get(e)};this.records.push(i)}_addObject(e,t){let i={i:t,$:{}};this.keys.forEach((n,a)=>{let r=n.getFn?n.getFn(e):this.getFn(e,n.path);if(O(r)){if(k(r)){let c=[];const o=[{nestedArrIndex:-1,value:r}];for(;o.length;){const{nestedArrIndex:l,value:h}=o.pop();if(O(h))if(b(h)&&!X(h)){let m={v:h,i:l,n:this.norm.get(h)};c.push(m)}else k(h)&&h.forEach((m,I)=>{o.push({nestedArrIndex:I,value:m})})}i.$[a]=c}else if(b(r)&&!X(r)){let c={v:r,n:this.norm.get(r)};i.$[a]=c}}}),this.records.push(i)}toJSON(){return{keys:this.keys,records:this.records}}}function he(s,e,{getFn:t=f.getFn,fieldNormWeight:i=f.fieldNormWeight}={}){const n=new J({getFn:t,fieldNormWeight:i});return n.setKeys(s.map(le)),n.setSources(e),n.create(),n}function Pe(s,{getFn:e=f.getFn,fieldNormWeight:t=f.fieldNormWeight}={}){const{keys:i,records:n}=s,a=new J({getFn:e,fieldNormWeight:t});return a.setKeys(i),a.setIndexRecords(n),a}function F(s,{errors:e=0,currentLocation:t=0,expectedLocation:i=0,distance:n=f.distance,ignoreLocation:a=f.ignoreLocation}={}){const r=e/s.length;if(a)return r;const c=Math.abs(i-t);return n?r+c/n:c?1:r}function $e(s=[],e=f.minMatchCharLength){let t=[],i=-1,n=-1,a=0;for(let r=s.length;a<r;a+=1){let c=s[a];c&&i===-1?i=a:!c&&i!==-1&&(n=a-1,n-i+1>=e&&t.push([i,n]),i=-1)}return s[a-1]&&a-i>=e&&t.push([i,a-1]),t}const P=32;function De(s,e,t,{location:i=f.location,distance:n=f.distance,threshold:a=f.threshold,findAllMatches:r=f.findAllMatches,minMatchCharLength:c=f.minMatchCharLength,includeMatches:o=f.includeMatches,ignoreLocation:l=f.ignoreLocation}={}){if(e.length>P)throw new Error(Se(P));const h=e.length,m=s.length,I=Math.max(0,Math.min(i,m));let w=a,d=I;const M=c>1||o,g=M?Array(m):[];let y;for(;(y=s.indexOf(e,d))>-1;){let x=F(e,{currentLocation:y,expectedLocation:I,distance:n,ignoreLocation:l});if(w=Math.min(x,w),d=y+h,M){let N=0;for(;N<h;)g[y+N]=1,N+=1}}d=-1;let E=[],T=1,A=h+m;const v=1<<h-1;for(let x=0;x<h;x+=1){let N=0,L=A;for(;N<L;)F(e,{errors:x,currentLocation:I+L,expectedLocation:I,distance:n,ignoreLocation:l})<=w?N=L:A=L,L=Math.floor((A-N)/2+N);A=L;let Q=Math.max(1,I-L+1),Y=r?m:Math.min(I+L,m)+h,$=Array(Y+2);$[Y+1]=(1<<x)-1;for(let H=Y;H>=Q;H-=1){let G=H-1,Z=t[s.charAt(G)];if(M&&(g[G]=+!!Z),$[H]=($[H+1]<<1|1)&Z,x&&($[H]|=(E[H+1]|E[H])<<1|1|E[H+1]),$[H]&v&&(T=F(e,{errors:x,currentLocation:G,expectedLocation:I,distance:n,ignoreLocation:l}),T<=w)){if(w=T,d=G,d<=I)break;Q=Math.max(1,2*I-d)}}if(F(e,{errors:x+1,currentLocation:I,expectedLocation:I,distance:n,ignoreLocation:l})>w)break;E=$}const S={isMatch:d>=0,score:Math.max(.001,T)};if(M){const x=$e(g,c);x.length?o&&(S.indices=x):S.isMatch=!1}return S}function Ge(s){let e={};for(let t=0,i=s.length;t<i;t+=1){const n=s.charAt(t);e[n]=(e[n]||0)|1<<i-t-1}return e}class de{constructor(e,{location:t=f.location,threshold:i=f.threshold,distance:n=f.distance,includeMatches:a=f.includeMatches,findAllMatches:r=f.findAllMatches,minMatchCharLength:c=f.minMatchCharLength,isCaseSensitive:o=f.isCaseSensitive,ignoreLocation:l=f.ignoreLocation}={}){if(this.options={location:t,threshold:i,distance:n,includeMatches:a,findAllMatches:r,minMatchCharLength:c,isCaseSensitive:o,ignoreLocation:l},this.pattern=o?e:e.toLowerCase(),this.chunks=[],!this.pattern.length)return;const h=(I,w)=>{this.chunks.push({pattern:I,alphabet:Ge(I),startIndex:w})},m=this.pattern.length;if(m>P){let I=0;const w=m%P,d=m-w;for(;I<d;)h(this.pattern.substr(I,P),I),I+=P;if(w){const M=m-P;h(this.pattern.substr(M),M)}}else h(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,includeMatches:i}=this.options;if(t||(e=e.toLowerCase()),this.pattern===e){let d={isMatch:!0,score:0};return i&&(d.indices=[[0,e.length-1]]),d}const{location:n,distance:a,threshold:r,findAllMatches:c,minMatchCharLength:o,ignoreLocation:l}=this.options;let h=[],m=0,I=!1;this.chunks.forEach(({pattern:d,alphabet:M,startIndex:g})=>{const{isMatch:y,score:E,indices:T}=De(e,d,M,{location:n+g,distance:a,threshold:r,findAllMatches:c,minMatchCharLength:o,includeMatches:i,ignoreLocation:l});y&&(I=!0),m+=E,y&&T&&(h=[...h,...T])});let w={isMatch:I,score:I?m/this.chunks.length:1};return I&&i&&(w.indices=h),w}}class _{constructor(e){this.pattern=e}static isMultiMatch(e){return te(e,this.multiRegex)}static isSingleMatch(e){return te(e,this.singleRegex)}search(){}}function te(s,e){const t=s.match(e);return t?t[1]:null}class Fe extends _{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}}class je extends _{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const i=e.indexOf(this.pattern)===-1;return{isMatch:i,score:i?0:1,indices:[0,e.length-1]}}}class Ye extends _{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}}class Xe extends _{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}}class We extends _{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}}class Ke extends _{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}}class ue extends _{constructor(e,{location:t=f.location,threshold:i=f.threshold,distance:n=f.distance,includeMatches:a=f.includeMatches,findAllMatches:r=f.findAllMatches,minMatchCharLength:c=f.minMatchCharLength,isCaseSensitive:o=f.isCaseSensitive,ignoreLocation:l=f.ignoreLocation}={}){super(e),this._bitapSearch=new de(e,{location:t,threshold:i,distance:n,includeMatches:a,findAllMatches:r,minMatchCharLength:c,isCaseSensitive:o,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class fe extends _{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t=0,i;const n=[],a=this.pattern.length;for(;(i=e.indexOf(this.pattern,t))>-1;)t=i+a,n.push([i,t-1]);const r=!!n.length;return{isMatch:r,score:r?0:1,indices:n}}}const K=[Fe,fe,Ye,Xe,Ke,We,je,ue],se=K.length,Ue=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,Ve="|";function ze(s,e={}){return s.split(Ve).map(t=>{let i=t.trim().split(Ue).filter(a=>a&&!!a.trim()),n=[];for(let a=0,r=i.length;a<r;a+=1){const c=i[a];let o=!1,l=-1;for(;!o&&++l<se;){const h=K[l];let m=h.isMultiMatch(c);m&&(n.push(new h(m,e)),o=!0)}if(!o)for(l=-1;++l<se;){const h=K[l];let m=h.isSingleMatch(c);if(m){n.push(new h(m,e));break}}}return n})}const Be=new Set([ue.type,fe.type]);class Je{constructor(e,{isCaseSensitive:t=f.isCaseSensitive,includeMatches:i=f.includeMatches,minMatchCharLength:n=f.minMatchCharLength,ignoreLocation:a=f.ignoreLocation,findAllMatches:r=f.findAllMatches,location:c=f.location,threshold:o=f.threshold,distance:l=f.distance}={}){this.query=null,this.options={isCaseSensitive:t,includeMatches:i,minMatchCharLength:n,findAllMatches:r,ignoreLocation:a,location:c,threshold:o,distance:l},this.pattern=t?e:e.toLowerCase(),this.query=ze(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:i,isCaseSensitive:n}=this.options;e=n?e:e.toLowerCase();let a=0,r=[],c=0;for(let o=0,l=t.length;o<l;o+=1){const h=t[o];r.length=0,a=0;for(let m=0,I=h.length;m<I;m+=1){const w=h[m],{isMatch:d,indices:M,score:g}=w.search(e);if(d){if(a+=1,c+=g,i){const y=w.constructor.type;Be.has(y)?r=[...r,...M]:r.push(M)}}else{c=0,a=0,r.length=0;break}}if(a){let m={isMatch:!0,score:c/a};return i&&(m.indices=r),m}}return{isMatch:!1,score:1}}}const U=[];function Qe(...s){U.push(...s)}function V(s,e){for(let t=0,i=U.length;t<i;t+=1){let n=U[t];if(n.condition(s,e))return new n(s,e)}return new de(s,e)}const j={AND:"$and",OR:"$or"},z={PATH:"$path",PATTERN:"$val"},B=s=>!!(s[j.AND]||s[j.OR]),Ze=s=>!!s[z.PATH],qe=s=>!k(s)&&ce(s)&&!B(s),ie=s=>({[j.AND]:Object.keys(s).map(e=>({[e]:s[e]}))});function me(s,e,{auto:t=!0}={}){const i=n=>{let a=Object.keys(n);const r=Ze(n);if(!r&&a.length>1&&!B(n))return i(ie(n));if(qe(n)){const o=r?n[z.PATH]:a[0],l=r?n[z.PATTERN]:n[o];if(!b(l))throw new Error(xe(o));const h={keyId:W(o),pattern:l};return t&&(h.searcher=V(l,e)),h}let c={children:[],operator:a[0]};return a.forEach(o=>{const l=n[o];k(l)&&l.forEach(h=>{c.children.push(i(h))})}),c};return B(s)||(s=ie(s)),i(s)}function et(s,{ignoreFieldNorm:e=f.ignoreFieldNorm}){s.forEach(t=>{let i=1;t.matches.forEach(({key:n,norm:a,score:r})=>{const c=n?n.weight:null;i*=Math.pow(r===0&&c?Number.EPSILON:r,(c||1)*(e?1:a))}),t.score=i})}function tt(s,e){const t=s.matches;e.matches=[],O(t)&&t.forEach(i=>{if(!O(i.indices)||!i.indices.length)return;const{indices:n,value:a}=i;let r={indices:n,value:a};i.key&&(r.key=i.key.src),i.idx>-1&&(r.refIndex=i.idx),e.matches.push(r)})}function st(s,e){e.score=s.score}function it(s,e,{includeMatches:t=f.includeMatches,includeScore:i=f.includeScore}={}){const n=[];return t&&n.push(tt),i&&n.push(st),s.map(a=>{const{idx:r}=a,c={item:e[r],refIndex:r};return n.length&&n.forEach(o=>{o(a,c)}),c})}class D{constructor(e,t={},i){this.options={...f,...t},this.options.useExtendedSearch,this._keyStore=new Ne(this.options.keys),this.setCollection(e,i)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof J))throw new Error(Re);this._myIndex=t||he(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){O(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let i=0,n=this._docs.length;i<n;i+=1){const a=this._docs[i];e(a,i)&&(this.removeAt(i),i-=1,n-=1,t.push(a))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:i,includeScore:n,shouldSort:a,sortFn:r,ignoreFieldNorm:c}=this.options;let o=b(e)?b(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return et(o,{ignoreFieldNorm:c}),a&&o.sort(r),ae(t)&&t>-1&&(o=o.slice(0,t)),it(o,this._docs,{includeMatches:i,includeScore:n})}_searchStringList(e){const t=V(e,this.options),{records:i}=this._myIndex,n=[];return i.forEach(({v:a,i:r,n:c})=>{if(!O(a))return;const{isMatch:o,score:l,indices:h}=t.searchIn(a);o&&n.push({item:a,idx:r,matches:[{score:l,value:a,norm:c,indices:h}]})}),n}_searchLogical(e){const t=me(e,this.options),i=(c,o,l)=>{if(!c.children){const{keyId:m,searcher:I}=c,w=this._findMatches({key:this._keyStore.get(m),value:this._myIndex.getValueForItemAtKeyId(o,m),searcher:I});return w&&w.length?[{idx:l,item:o,matches:w}]:[]}const h=[];for(let m=0,I=c.children.length;m<I;m+=1){const w=c.children[m],d=i(w,o,l);if(d.length)h.push(...d);else if(c.operator===j.AND)return[]}return h},n=this._myIndex.records,a={},r=[];return n.forEach(({$:c,i:o})=>{if(O(c)){let l=i(t,c,o);l.length&&(a[o]||(a[o]={idx:o,item:c,matches:[]},r.push(a[o])),l.forEach(({matches:h})=>{a[o].matches.push(...h)}))}}),r}_searchObjectList(e){const t=V(e,this.options),{keys:i,records:n}=this._myIndex,a=[];return n.forEach(({$:r,i:c})=>{if(!O(r))return;let o=[];i.forEach((l,h)=>{o.push(...this._findMatches({key:l,value:r[h],searcher:t}))}),o.length&&a.push({idx:c,item:r,matches:o})}),a}_findMatches({key:e,value:t,searcher:i}){if(!O(t))return[];let n=[];if(k(t))t.forEach(({v:a,i:r,n:c})=>{if(!O(a))return;const{isMatch:o,score:l,indices:h}=i.searchIn(a);o&&n.push({score:l,key:e,value:a,idx:r,norm:c,indices:h})});else{const{v:a,n:r}=t,{isMatch:c,score:o,indices:l}=i.searchIn(a);c&&n.push({score:o,key:e,value:a,norm:r,indices:l})}return n}}D.version="6.6.2";D.createIndex=he;D.parseIndex=Pe;D.config=f;D.parseQuery=me;Qe(Je);class R{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";CHARACTER_CACHE;USER_REGISTERED;LOADING;playerId;playerColor;playerName;playerMetadata;playerRole;locked;party;lastParty;gridDpi;gridScale;storedMetaItems;sceneItems;sceneSelected;sceneMetadata;sceneReady;oldRoomMetadata;roomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.lastParty=[],this.storedMetaItems=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.oldRoomMetadata={},this.roomMetadata={},this.locked=!1,this.LOADING=!1,this.CHARACTER_CACHE=[],this.USER_REGISTERED=!1,this.caches=e}async InitializeCache(){if(this.sceneReady=await u.scene.isReady(),this.theme=await u.theme.getTheme(),ne(this.theme,document),this.caches.includes(R.PLAYER)&&(this.playerId=await u.player.getId(),this.playerName=await u.player.getName(),this.playerColor=await u.player.getColor(),this.playerMetadata=await u.player.getMetadata(),this.playerRole=await u.player.getRole()),this.caches.includes(R.PARTY)&&(this.party=await u.party.getPlayers()),this.caches.includes(R.SCENEITEMS)&&this.sceneReady){const e=await u.scene.items.getItems(),t=[];for(const i of e){let n=i;n.secretIdentity=i.id,n.text?.plainText&&(n.customTextName=n.text.plainText),t.push(n)}this.sceneItems=t}this.caches.includes(R.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await u.scene.getMetadata()),this.caches.includes(R.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(R.ROOMMETA)&&this.sceneReady&&(this.roomMetadata=await u.room.getMetadata())}KillHandlers(){this.caches.includes(R.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(R.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(R.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(R.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(R.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(R.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(R.SCENEMETA)&&(this.sceneMetadataHandler=u.scene.onMetadataChange(async e=>{const t=document.querySelector("#app"),i=document.querySelector("#locked");this.storedMetaItems=e[`${C.EXTENSIONID}/stored`],this.storedMetaItems||(this.storedMetaItems=[]);const n=e[`${C.EXTENSIONID}/locked`];this.locked=!!n,p.playerRole==="PLAYER"&&(this.locked?(t.hidden=!0,t.style.display="none",i.hidden=!1,await u.action.setHeight(50)):(t.hidden=!1,t.style.display="flex",i.hidden=!0,await u.action.setHeight(300))),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(R.SCENEITEMS)&&(this.sceneItemsHandler=u.scene.items.onChange(async e=>{const t=[];for(const i of e){let n=i;n.secretIdentity=i.id,n.text?.plainText&&(n.customTextName=n.text.plainText),t.push(n)}this.sceneItems=t})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(R.SCENEGRID)&&(this.sceneGridHandler=u.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(R.PLAYER)&&(this.playerHandler=u.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(R.PARTY)&&(this.partyHandler=u.party.onChange(async e=>{this.party=e.filter(t=>t.id!==""),await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(R.ROOMMETA)&&(this.roomHandler=u.room.onMetadataChange(async e=>{this.roomMetadata=e,await this.OnRoomMetadataChange(e),this.oldRoomMetadata=e})),this.themeHandler===void 0&&(this.themeHandler=u.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=u.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await u.scene.items.getItems(),this.sceneMetadata=await u.scene.getMetadata(),this.gridDpi=await u.scene.grid.getDpi(),this.gridScale=(await u.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){}async OnSceneItemsChange(e){}async OnSceneGridChange(e){}async OnSceneReadyChange(e){e?await pe():document.querySelector("#app").innerHTML='<div id="startup">Awaiting Scene..</div>'}async OnPlayerChange(e){}async OnPartyChange(e){}async OnRoomMetadataChange(e){}async OnThemeChange(e){ne(e,document)}async CheckRegistration(){try{const e=window.location.origin.includes("localhost")?"eternaldream":"",t={owlbearid:p.playerId},i={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:C.ANONAUTH,"x-manuel":e}),body:JSON.stringify(t)},n=await fetch(C.CHECKREGISTRATION,i);if(!n.ok){const r=await n.json();console.error("Error:",r);return}(await n.json()).Data==="OK"?(this.USER_REGISTERED=!0,console.log("Connected")):console.log("Not Registered")}catch(e){console.error("Error:",e)}}}const p=new R([R.SCENEITEMS,R.PLAYER]);function nt(){const s=document.createElement("img");s.id="whatsNewButton",s.setAttribute("class","icon"),s.classList.add("clickable"),s.setAttribute("title","Whats New?"),s.setAttribute("src","/w-info.svg"),s.onclick=async function(){try{localStorage.setItem(C.VERSION,"true"),s.classList.remove("whats-new-shine")}catch{}await u.modal.open({id:C.EXTENSIONWHATSNEW,url:`/bswhatsnew.html?subscriber=${p.USER_REGISTERED}`,height:500,width:350})};try{localStorage.getItem(C.VERSION)!=="true"&&s.classList.add("whats-new-shine")}catch{}return s}function ne(s,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),i=t.matches?"dark":"light",n=t.matches?"light":"dark";for(var a=0;a<e.styleSheets.length;a++)for(var r=0;r<e.styleSheets[a].cssRules.length;r++){let c=e.styleSheets[a].cssRules[r];c&&c.media&&c.media.mediaText.includes("prefers-color-scheme")&&(s.mode=="LIGHT"?(c.media.appendMedium(`(prefers-color-scheme: ${i})`),c.media.mediaText.includes(n)&&c.media.deleteMedium(`(prefers-color-scheme: ${n})`)):s.mode=="DARK"&&(c.media.appendMedium(`(prefers-color-scheme: ${n})`),c.media.mediaText.includes(i)&&c.media.deleteMedium(`(prefers-color-scheme: ${i})`)))}}class re{static async CenterViewportOnImage(e){const t=await u.scene.grid.getDpi(),i=await u.viewport.getScale(),n=await u.viewport.getWidth(),a=await u.viewport.getHeight(),r={x:n/2,y:a/2},c={x:r.x/i,y:r.y/i},o=await this.GetImageCenter(e,t),l={x:o.x-c.x,y:o.y-c.y},h={x:l.x*i*-1,y:l.y*i*-1};await u.viewport.animateTo({position:h,scale:i})}static async GetImageCenter(e,t){if(ye(e)){const i=t/e.grid.dpi,n=e.image.width*i,a=e.image.height*i,r=e.grid.offset.x/e.image.width*n,c=e.grid.offset.y/e.image.height*a;return{x:e.position.x-r+n/2,y:e.position.y-c+a/2}}else return ge(e)&&e.points.length>0?{x:e.points[0].x,y:e.points[0].y}:{x:e.position.x,y:e.position.y}}}document.querySelector("#app").innerHTML='<div id="startup">Awaiting scene...</div>';u.onReady(async()=>{await p.InitializeCache(),setTimeout(async()=>{p.sceneReady===!1&&await p.InitializeCache(),p.SetupHandlers(),p.sceneReady&&await pe()},1e3)});async function pe(){p.playerRole==="GM"?document.querySelector("#app").innerHTML=`
            <table>
                <colgroup>
                    <col style="width: 40%;">  
                    <col style="width: 20%;">  
                    <col style="width: 20%;">  
                    <col style="width: 10%;">  
                    <col style="width: 10%;">  
                </colgroup>
                <tr>
                    <td colspan="4"><div id="header">Scry!</div></td>
                    <td><div id="whatsNew"></div></td>
                </tr>
                <tr>
                    <td colspan="3">
                        <div style="display:flex;">
                            <div class="wrapper">
                                <input type="text" id="searchBar" class="searchBar" onkeyup="StartSearch()" placeholder="Search for..">
                                <button id="clearSearch" class="clear">X</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div id="toggler" class="toggler"></div>
                    </td>
                    <td>
                        <div id="counter" class="count"></div>
                    </td>
                </tr>
                <tr>
                    <td colspan="5">
                        <div class="scrollable">
                            <ol id="searchList"></ol>
                        </div>
                    </td>
                </tr>
            </table>
        `:document.querySelector("#app").innerHTML=`
            <table>
                <colgroup>
                    <col style="width: 40%;">  
                    <col style="width: 20%;">  
                    <col style="width: 20%;">  
                    <col style="width: 10%;">  
                    <col style="width: 10%;">  
                </colgroup>
                <tr>
                    <td colspan="4"><div id="header">Scry!</div></td>
                    <td><div id="whatsNew"></div></td>
                </tr>
                <tr>
                    <td colspan="4">
                        <div style="display:flex;">
                            <div class="wrapper">
                                <input type="text" id="searchBar" class="playersearchBar" onkeyup="StartSearch()" placeholder="Search for..">
                                <button id="clearSearch" class="playerclear">X</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div id="counter" class="count"></div>
                    </td>
                </tr>
                <tr>
                    <td colspan="5">
                        <div class="scrollable">
                            <ol id="searchList"></ol>
                        </div>
                    </td>
                </tr>
            </table>
        `;const s=document.getElementById("searchList"),e=document.getElementById("searchBar"),t=document.getElementById("counter"),i=document.getElementById("toggler");t.innerText="...",t.title="Number of Results";const n=document.getElementById("clearSearch");if(p.playerRole==="GM"){const r=document.createElement("input");r.type="image",r.title="Disable Player Access",r.className="toggleClickable",r.value=p.locked?"on":"off",r.onclick=async function(c){c.stopPropagation(),r.value==="off"?(r.value="on",r.src="/lock.svg",await u.scene.setMetadata({[`${C.EXTENSIONID}/locked`]:!0})):(r.value="off",r.src="/unlock.svg",await u.scene.setMetadata({[`${C.EXTENSIONID}/locked`]:!1}))},r.src=p.locked?"/lock.svg":"/unlock.svg",i.appendChild(r)}n.title="Clear Search",n.onclick=()=>{e.value="",s.innerHTML="",t.innerText="..."},document.getElementById("whatsNew").appendChild(nt()),e.onkeyup=()=>{const r=e.value.toUpperCase().trim();if(!r||r.length<2)return t.innerText="...",s.innerHTML="";const[c,o]=I(r);let l=[];switch(c){case"ALL":case"EVERYTHING":l=p.sceneItems.map(y=>({item:{...y},matches:[],score:1}));break;case"ID":l=w(p.sceneItems,o,["secretIdentity"]);break;case"MAP":case"PROP":case"MOUNT":case"CHARACTER":case"ATTACHMENT":case"NOTE":case"FOG":case"TEXT":const d=p.sceneItems.filter(y=>y.layer===c);o?l=w(d,o,["name","customTextName"],.4):l=d.map(y=>({item:{...y},matches:[],score:1}));break;default:const M=["ATTACHMENT","CHARACTER","PROP","MOUNT","MAP","TEXT"],g=p.sceneItems.filter(y=>M.includes(y.layer));l=w(g,o,["name","customTextName"],.4);break}s.innerHTML="",t.innerText="...";let h=1,m=0;if(l.length>0){m=p.playerRole==="GM"?l.length:l.filter(d=>d.item.visible===!0).length,t.innerText=m.toString();for(const d of l){if(d.item.visible===!1&&p.playerRole!=="GM")continue;const M=document.createElement("li");let g=d.item.name.toUpperCase().includes(o)?"":` (${d.item.customTextName})`;(g===" ()"||g===" (undefined)")&&(g=""),M.id="li-"+d.item.id,M.innerHTML=`${h}.   ${d.item.name}${g}${d.item.visible?"":" (Hidden)"}`,M.title=d.item.secretIdentity;const y=document.createElement("div");if(y.className="listdiv",p.playerRole==="GM"){const E=document.createElement("input");E.type="image",E.title="Vanish this Item",E.className="clickable",E.value="off",E.onclick=async function(A){if(A.stopPropagation(),E.value==="off"){await u.player.deselect([d.item.id]);const v=await u.scene.items.getItems([d.item.id]);if(v.length>0){const S=v[0];S.secretIdentity=S.id,S.text?.plainText&&(S.customTextName=S.text.plainText),p.storedMetaItems.push(S),await u.scene.items.deleteItems([d.item.id]),E.value="on",E.src="/eyeclosed.svg",await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems})}}else{const v=p.storedMetaItems.find(S=>S.id===d.item.id);v&&(delete v.customTextName,delete v.secretIdentity,await u.scene.items.addItems([v]),p.storedMetaItems=p.storedMetaItems.filter(S=>S.id!==d.item.id),E.value="off",E.src="/eyeopen.svg",await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems}))}},E.src="/eyeopen.svg";const T=document.createElement("input");T.type="image",T.title="Delete this Item",T.className="clickable",T.src="/trash.svg",T.onclick=async function(A){A.stopPropagation(),await u.scene.items.deleteItems([d.item.id]),p.storedMetaItems=p.storedMetaItems.filter(v=>v.id!==d.item.id),await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems}),M.remove(),t.innerText=(+t.innerText-1).toString()},y.appendChild(T),y.appendChild(E)}M.appendChild(y),M.onclick=async()=>{re.CenterViewportOnImage(d.item),await u.player.select([d.item.id])},s.appendChild(M),h++}}if(p.playerRole==="GM"){let d=[];switch(c){case"ALL":case"EVERYTHING":d=p.storedMetaItems.map(E=>({item:{...E},matches:[],score:1}));break;case"ID":d=w(p.storedMetaItems,o,["secretIdentity"]);break;case"MAP":case"PROP":case"MOUNT":case"CHARACTER":case"ATTACHMENT":case"NOTE":case"FOG":case"TEXT":const M=p.storedMetaItems.filter(E=>E.layer===c);o?d=w(M,o,["name","customTextName"],.4):d=M.map(E=>({item:{...E},matches:[],score:1}));break;default:const g=["ATTACHMENT","CHARACTER","PROP","MOUNT","MAP","TEXT"],y=p.storedMetaItems.filter(E=>g.includes(E.layer));d=w(y,o,["name","customTextName"],.4);break}if(d.length>0){const M=p.playerRole==="GM"?d.length:d.filter(g=>g.item.visible===!0).length;t.innerText=m>0?(m+M).toString():M.toString();for(const g of d){if(g.item.visible===!1&&p.playerRole!=="GM")continue;const y=document.createElement("li");let E=g.item.name.toUpperCase().includes(o)?"":` (${g.item.text?.plainText})`;(E===" ()"||E===" (undefined)")&&(E=""),y.id="li-"+g.item.id,y.innerHTML=`${h}.   ${g.item.name}${E}${g.item.visible?"":" (Hidden)"}`;const T=document.createElement("input");T.type="image",T.title="Restore this Item",T.className="clickable",T.value="off",T.onclick=async function(S){if(S.stopPropagation(),T.value==="off")delete g.item.customTextName,delete g.item.secretIdentity,await u.scene.items.addItems([g.item]),p.storedMetaItems=p.storedMetaItems.filter(x=>x.id!==g.item.id),T.src="/eyeopen.svg",T.value="on",await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems});else{const x=await u.scene.items.getItems([g.item.id]);if(x.length>0){const N=x[0];N.secretIdentity=N.id,N.text?.plainText&&(N.customTextName=N.text.plainText),p.storedMetaItems.push(N),await u.player.deselect([g.item.id]),await u.scene.items.deleteItems([g.item.id]),T.value="off",T.src="/eyeclosed.svg",await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems})}}},T.src="/eyeclosed.svg";const A=document.createElement("input");A.type="image",A.title="Delete this Item",A.className="clickable",A.src="/trash.svg",A.onclick=async function(S){S.stopPropagation(),await u.scene.items.deleteItems([g.item.id]),p.storedMetaItems=p.storedMetaItems.filter(x=>x.id!==g.item.id),await u.scene.setMetadata({[`${C.EXTENSIONID}/stored`]:p.storedMetaItems}),y.remove(),t.innerText=(+t.innerText-1).toString()};const v=document.createElement("div");v.className="listdiv",v.appendChild(A),v.appendChild(T),y.appendChild(v),y.onclick=async()=>{re.CenterViewportOnImage(g.item),await u.player.select([g.item.id])},s.appendChild(y),h++}}}function I(d){const M=d.indexOf(":");if(M!==-1){const g=d.substring(0,M),y=d.substring(M+1);return[g,y]}return["",d]}function w(d,M,g,y=0){return new D(d,{threshold:y,includeScore:!0,keys:g}).search(M)}}}
